<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - HRMS Admin</title>
    <!-- Enhanced CSS -->
    <link rel="stylesheet" href="../assets/css/enhanced.css">
    <link rel="stylesheet" href="../assets/css/dashboard-enhanced.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¢ HRMS Admin</h2>
                <p>N.T Woods Pvt. Ltd.</p>
            </div>
            
            <nav class="sidebar-menu">
                <a href="dashboard.html" class="menu-item">
                    <span class="menu-item-icon">ğŸ“Š</span>
                    <span>Dashboard</span>
                </a>
                <a href="users.html" class="menu-item">
                    <span class="menu-item-icon">ğŸ‘¥</span>
                    <span>User Management</span>
                </a>
                <a href="permissions.html" class="menu-item">
                    <span class="menu-item-icon">ğŸ”</span>
                    <span>Permissions</span>
                </a>
                <a href="templates.html" class="menu-item">
                    <span class="menu-item-icon">ğŸ“</span>
                    <span>Job Templates</span>
                </a>
                <a href="requirements.html" class="menu-item">
                    <span class="menu-item-icon">ğŸ“‹</span>
                    <span>Requirements</span>
                </a>
                <a href="candidates.html" class="menu-item">
                    <span class="menu-item-icon">ğŸ‘¤</span>
                    <span>Candidates</span>
                </a>
                <a href="tests.html" class="menu-item">
                    <span class="menu-item-icon">âœï¸</span>
                    <span>Test Management</span>
                </a>
                <a href="reports.html" class="menu-item active">
                    <span class="menu-item-icon">ğŸ“ˆ</span>
                    <span>Reports</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <h4 id="userName">Admin User</h4>
                        <p id="userRole">Administrator</p>
                    </div>
                </div>
                <button class="btn btn-secondary w-100" onclick="logout()">
                    <span>ğŸšª</span> Logout
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="menu-toggle" id="menuToggle">â˜°</button>
                    <div class="page-title">
                        <h1>Reports & Analytics</h1>
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="notification-icon">
                        ğŸ””
                        <span class="notification-badge">5</span>
                    </button>
                </div>
            </div>
            
            <!-- Content Area -->
            <div class="content-area">
                <div id="loadingSpinner" class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading dashboard statistics...</p>
                </div>

                <div id="dashboardContent" style="display: none;">
                    <!-- Dashboard Statistics -->
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                ğŸ“‹
                            </div>
                            <div class="stat-content">
                                <h3 id="totalRequirements">0</h3>
                                <p>Total Requirements</p>
                            </div>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="exportStage('requirements')">ğŸ“¥ Export</button>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon info">
                                ğŸ‘¥
                            </div>
                            <div class="stat-content">
                                <h3 id="totalCandidates">0</h3>
                                <p>Total Candidates</p>
                            </div>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="exportStage('all')">ğŸ“¥ Export</button>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                âœ“
                            </div>
                            <div class="stat-content">
                                <h3 id="shortlistedCandidates">0</h3>
                                <p>Shortlisted</p>
                            </div>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="exportStage('Shortlisted')">ğŸ“¥ Export</button>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                ğŸ”„
                            </div>
                            <div class="stat-content">
                                <h3 id="inProcessCandidates">0</h3>
                                <p>In Process</p>
                            </div>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="exportStage('process')">ğŸ“¥ Export</button>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon danger">
                                âœ•
                            </div>
                            <div class="stat-content">
                                <h3 id="rejectedCandidates">0</h3>
                                <p>Rejected</p>
                            </div>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="exportStage('Rejected')">ğŸ“¥ Export</button>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon success">
                                ğŸ‰
                            </div>
                            <div class="stat-content">
                                <h3 id="hiredCandidates">0</h3>
                                <p>Hired</p>
                            </div>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="exportStage('Hired')">ğŸ“¥ Export</button>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3>ğŸ“Š Candidates by Status</h3>
                                </div>
                                <div class="card-body">
                                    <div id="statusChart" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                                        <p class="text-muted">Chart placeholder - Integrate Chart.js for visualization</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3>ğŸ“ˆ Candidates by Role</h3>
                                </div>
                                <div class="card-body">
                                    <div id="roleChart" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                                        <p class="text-muted">Chart placeholder - Integrate Chart.js for visualization</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Source Analytics -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h3>ğŸ¯ Source Analytics</h3>
                        </div>
                        <div class="card-body">
                            <div id="sourceChart" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                                <p class="text-muted">Chart placeholder - Integrate Chart.js for visualization</p>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Trend -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h3>ğŸ“… Monthly Trend</h3>
                        </div>
                        <div class="card-body">
                            <div id="monthlyChart" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
                                <p class="text-muted">Chart placeholder - Integrate Chart.js for visualization</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../config.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/admin-common.js"></script>
    <script>
        let dashboardData = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadDashboardStats();
        });

        async function loadDashboardStats() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const dashboardContent = document.getElementById('dashboardContent');

            loadingSpinner.style.display = 'block';
            dashboardContent.style.display = 'none';

            try {
                const response = await apiCall('getDashboardStats', {});
                
                if (response.success && response.stats) {
                    dashboardData = response.stats;
                    displayStats(response.stats);
                } else {
                    throw new Error(response.message || 'Failed to load dashboard stats');
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showToast('Failed to load dashboard stats: ' + error.message, 'error');
                loadingSpinner.style.display = 'none';
            }
        }

        function displayStats(stats) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const dashboardContent = document.getElementById('dashboardContent');

            // Update stat cards
            document.getElementById('totalRequirements').textContent = stats.totalRequirements || 0;
            document.getElementById('totalCandidates').textContent = stats.totalCandidates || 0;
            document.getElementById('shortlistedCandidates').textContent = stats.shortlisted || 0;
            
            // Calculate in-process (Called, Recommended, Approved, Scheduled, Appeared)
            const inProcess = (stats.called || 0) + (stats.recommended || 0) + 
                            (stats.approved || 0) + (stats.scheduled || 0) + (stats.appeared || 0);
            document.getElementById('inProcessCandidates').textContent = inProcess;
            
            document.getElementById('rejectedCandidates').textContent = stats.rejected || 0;
            document.getElementById('hiredCandidates').textContent = stats.hired || 0;

            loadingSpinner.style.display = 'none';
            dashboardContent.style.display = 'block';
        }

        async function exportStage(stage) {
            try {
                let response;
                let filename;
                
                if (stage === 'requirements') {
                    response = await apiCall('getRequirements', {});
                    filename = 'requirements';
                } else if (stage === 'all') {
                    response = await apiCall('getCandidates', {});
                    filename = 'all_candidates';
                } else if (stage === 'process') {
                    response = await apiCall('getCandidates', {});
                    const processStages = ['Called', 'Recommended', 'Approved', 'Scheduled', 'Appeared'];
                    response.candidates = response.candidates?.filter(c => processStages.includes(c.status));
                    filename = 'inprocess_candidates';
                } else {
                    response = await apiCall('getCandidates', { status: stage });
                    filename = stage.toLowerCase() + '_candidates';
                }

                if (!response.success) {
                    throw new Error(response.message || 'Failed to export data');
                }

                const data = response.requirements || response.candidates || [];
                
                if (data.length === 0) {
                    showToast('No data to export', 'warning');
                    return;
                }

                // Generate CSV
                let headers, rows;
                if (stage === 'requirements') {
                    headers = ['ID', 'Job Title', 'Role', 'Status', 'Raised By', 'Raised Date'];
                    rows = data.map((r, i) => [
                        i + 1,
                        r.jobTitle || '',
                        r.jobRole || '',
                        r.status || '',
                        r.raisedBy || '',
                        formatDate(r.raisedDate)
                    ]);
                } else {
                    headers = ['ID', 'Name', 'Mobile', 'Role', 'Source', 'Status', 'Upload Date'];
                    rows = data.map((c, i) => [
                        i + 1,
                        c.name || '',
                        c.mobile || '',
                        c.jobRole || '',
                        c.source || '',
                        c.status || '',
                        formatDate(c.uploadDate)
                    ]);
                }

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showToast('Data exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('Failed to export data: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
